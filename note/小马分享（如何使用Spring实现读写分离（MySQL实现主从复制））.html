<html>
<head>
  <title>小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="5222"/>
<h1>小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））</h1>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;line-height:1.15;text-size-adjust:100%;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size:12px;line-height:1.5;color:rgb(101, 113, 128);background-color:rgb(255, 255, 255);-webkit-font-smoothing:antialiased;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;zoom:1;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;font-size:34px;font-weight:700;line-height:44px;color:rgb(34, 34, 34);">小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））</h1> <div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;margin-top:12px;margin-bottom:20px;font-size:13px;"> <span style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;color:rgb(119, 119, 119);margin-right:2px;">路瑶之马厉</span> <span style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;color:rgb(119, 119, 119);margin-right:2px;">2017-11-22 11:27:57</span></div> <div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;margin-bottom:24px;font-size:16px;line-height:28px;color:rgb(34, 34, 34);word-wrap:break-word;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;font-size:16px;line-height:28px;color:rgb(34, 34, 34);word-wrap:break-word;"><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">背景</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">我们一般应用对数据库而言都是&quot;读多写少&quot;，也就说对数据库读取数据的压力比较大，有一个思路就是说采用数据库集群的方案，</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">其中一个是主库，负责写入数据，我们称之为：写库；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">其它都是从库，负责读取数据，我们称之为：读库；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">那么，对我们的要求是：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、 读库和写库的数据一致；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、 写数据必须写到写库；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3、 读数据必须到读库；</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">方案</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">解决读写分离的方案有两种：应用层解决和中间件解决。</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">应用层解决：</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><img src="小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））_files/46f800051b777c64da2b.jpg" type="image/jpeg" data-filename="46f800051b777c64da2b.jpg" alt="小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））" height="464" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;border-style:none;max-width:100%;display:block;margin:10px auto;" width="448"/></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">优点：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、 多数据源切换方便，由程序自动完成；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、 不需要引入中间件；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3、 理论上支持任何数据库；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">缺点：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、 由程序员完成，运维参与不到；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、 不能做到动态增加数据源；</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">中间件解决</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><img src="小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））_files/46fd0001912a5eeaa743.jpg" type="image/jpeg" data-filename="46fd0001912a5eeaa743.jpg" alt="小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））" height="546" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;border-style:none;max-width:100%;display:block;margin:10px auto;" width="460"/></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">优缺点：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">优点：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、 源程序不需要做任何改动就可以实现读写分离；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、 动态添加数据源不需要重启程序；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">缺点：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、 程序依赖于中间件，会导致切换数据库变得困难；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、 由中间件做了中转代理，性能有所下降；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">相关中间件产品使用：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">mysql-proxy：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">Amoeba for MySQL：和</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">使用Spring基于应用层实现</h1><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">原理</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><img src="小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））_files/46fd000191248e7fe6a9.jpg" type="image/jpeg" data-filename="46fd000191248e7fe6a9.jpg" alt="小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））" height="357" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;border-style:none;max-width:100%;display:block;margin:10px auto;" width="640"/></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">在进入Service之前，使用AOP来做出判断，是使用写库还是读库，判断依据可以根据方法名判断，比如说以query、find、get等开头的就走读库，其他的走写库。</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">DynamicDataSource</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 定义动态数据源，实现通过集成Spring提供的AbstractRoutingDataSource，只需要实现determineCurrentLookupKey方法即可</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 由于DynamicDataSource是单例的，线程不安全的，所以采用ThreadLocal保证线程安全，由DynamicDataSourceHolder完成。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@author</strong> zhijun</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">class</strong> DynamicDataSource <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">extends</strong> AbstractRoutingDataSource{</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">@Override</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">protected</strong> Object determineCurrentLookupKey() {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 使用DynamicDataSourceHolder保证线程安全，并且得到当前线程中的数据源key</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">return</strong> DynamicDataSourceHolder.<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">getDataSourceKey</em>();</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">DynamicDataSourceHolder</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 使用ThreadLocal技术来记录当前线程中的数据源的key</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@author</strong> zhijun</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">class</strong> DynamicDataSourceHolder {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">//写库对应的数据源key</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">private</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">static</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">final</strong> String <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">MASTER</em></strong> = &quot;master&quot;;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">//读库对应的数据源key</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">private</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">static</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">final</strong> String <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">SLAVE</em></strong> = &quot;slave&quot;;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">//使用ThreadLocal记录当前线程的数据源key</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">private</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">static</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">final</strong> ThreadLocal&lt;String&gt; <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">holder</em></strong> = <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">new</strong> ThreadLocal&lt;String&gt;();</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 设置数据源key</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@param</strong> key</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">static</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">void</strong> putDataSourceKey(String key) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">holder</em></strong>.set(key);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 获取数据源key</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@return</strong></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">static</strong> String getDataSourceKey() {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">return</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">holder</em></strong>.get();</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 标记写库</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">static</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">void</strong> markMaster(){</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">putDataSourceKey</em>(<strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">MASTER</em></strong>);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 标记读库</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">static</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">void</strong> markSlave(){</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">putDataSourceKey</em>(<strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">SLAVE</em></strong>);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">DataSourceAspect</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> org.apache.commons.lang3.StringUtils;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> org.aspectj.lang.JoinPoint;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 定义数据源的AOP切面，通过该Service的方法名判断是应该走读库还是写库</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@author</strong> zhijun</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">class</strong> DataSourceAspect {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 在进入Service方法之前执行</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@param</strong> point 切面对象</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">void</strong> before(JoinPoint point) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 获取到当前执行的方法名</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">String methodName = point.getSignature().getName();</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">if</strong> (isSlave(methodName)) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 标记为读库</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">DynamicDataSourceHolder.<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">markSlave</em>();</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">} <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">else</strong> {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 标记为写库</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">DynamicDataSourceHolder.<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">markMaster</em>();</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 判断是否为读库</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@param</strong> methodName</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@return</strong></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">private</strong> Boolean isSlave(String methodName) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 方法名以query、find、get开头的方法名走从库</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">return</strong> StringUtils.<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">startsWithAny</em>(methodName, &quot;query&quot;, &quot;find&quot;, &quot;get&quot;);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">配置2个数据源</h1><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">jdbc.properties</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">jdbc.master.driver=com.mysql.jdbc.Driver</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">jdbc.master.url=jdbc:mysql://127.0.0.1:3306/mybatis_1128?useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">jdbc.master.username=root</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">jdbc.master.password=123456</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">jdbc.slave01.driver=com.mysql.jdbc.Driver</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">jdbc.slave01.url=jdbc:mysql://127.0.0.1:3307/mybatis_1128?useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">jdbc.slave01.username=root</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">jdbc.slave01.password=123456</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">定义连接池</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 配置连接池 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;bean id=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;masterDataSource&quot;</em> class=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;com.jolbox.bonecp.BoneCPDataSource&quot;</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">destroy-method=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;close&quot;</em>&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 数据库驱动 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;driverClass&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;${jdbc.master.driver}&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 相应驱动的jdbcUrl --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;jdbcUrl&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;${jdbc.master.url}&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 数据库的用户名 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;username&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;${jdbc.master.username}&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 数据库的密码 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;password&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;${jdbc.master.password}&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 检查数据库连接池中空闲连接的间隔时间，单位是分，默认值：240，如果要取消则设置为0 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;idleConnectionTestPeriod&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;60&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 连接池中未使用的链接最大存活时间，单位是分，默认值：60，如果要永远存活设置为0 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;idleMaxAge&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;30&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 每个分区最大的连接数 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;maxConnectionsPerPartition&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;150&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 每个分区最小的连接数 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;minConnectionsPerPartition&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;5&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;/bean&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 配置连接池 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;bean id=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;slave01DataSource&quot;</em> class=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;com.jolbox.bonecp.BoneCPDataSource&quot;</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">destroy-method=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;close&quot;</em>&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 数据库驱动 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;driverClass&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;${jdbc.slave01.driver}&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 相应驱动的jdbcUrl --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;jdbcUrl&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;${jdbc.slave01.url}&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 数据库的用户名 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;username&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;${jdbc.slave01.username}&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 数据库的密码 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;password&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;${jdbc.slave01.password}&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 检查数据库连接池中空闲连接的间隔时间，单位是分，默认值：240，如果要取消则设置为0 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;idleConnectionTestPeriod&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;60&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 连接池中未使用的链接最大存活时间，单位是分，默认值：60，如果要永远存活设置为0 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;idleMaxAge&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;30&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 每个分区最大的连接数 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;maxConnectionsPerPartition&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;150&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 每个分区最小的连接数 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;minConnectionsPerPartition&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;5&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;/bean&gt;</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">定义DataSource</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 定义数据源，使用自己实现的数据源 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;bean id=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;dataSource&quot;</em> class=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;cn.itcast.usermanage.spring.DynamicDataSource&quot;</em>&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 设置多个数据源 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;targetDataSources&quot;</em>&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;map key-type=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;java.lang.String&quot;</em>&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 这个key需要和程序中的key一致 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;entry key=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;master&quot;</em> value-ref=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;masterDataSource&quot;</em>/&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;entry key=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;slave&quot;</em> value-ref=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;slave01DataSource&quot;</em>/&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;/map&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;/property&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 设置默认的数据源，这里默认走写库 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;defaultTargetDataSource&quot;</em> ref=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;masterDataSource&quot;</em>/&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;/bean&gt;</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">配置事务管理以及动态切换数据源切面</h1><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">定义事务管理器</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 定义事务管理器 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;bean id=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;transactionManager&quot;</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">class=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</em>&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;dataSource&quot;</em> ref=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;dataSource&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;/bean&gt;</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">定义事务策略</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 定义事务策略 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;tx:advice id=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;txAdvice&quot;</em> transaction-manager=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;transactionManager&quot;</em>&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;tx:attributes&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!--定义查询方法都是只读的 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;tx:method name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;query*&quot;</em> read-only=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;true&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;tx:method name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;find*&quot; </em>read-only=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;true&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;tx:method name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;get*&quot;</em> read-only=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;true&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 主库执行操作，事务传播行为定义为默认行为 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;tx:method name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;save*&quot;</em> propagation=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;REQUIRED&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;tx:method name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;update*&quot;</em> propagation=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;REQUIRED&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;tx:method name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;delete*&quot;</em> propagation=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;REQUIRED&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!--其他方法使用默认事务策略 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;tx:method name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;*&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;/tx:attributes&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;/tx:advice&gt;</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">定义切面</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 定义AOP切面处理器 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;bean class=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;cn.itcast.usermanage.spring.DataSourceAspect&quot;</em> id=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;dataSourceAspect&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;aop:config&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 定义切面，所有的service的所有方法 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;aop:pointcut id=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;txPointcut&quot;</em> expression=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;execution(* xx.xxx.xxxxxxx.service.*.*(..))&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 应用事务策略到Service切面 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;aop:advisor advice-ref=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;txAdvice&quot;</em> pointcut-ref=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;txPointcut&quot;</em>/&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 将切面应用到自定义的切面处理器上，-9999保证该切面优先级最高执行 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;aop:aspect ref=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;dataSourceAspect&quot;</em> order=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;-9999&quot;</em>&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;aop:before method=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;before&quot;</em> pointcut-ref=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;txPointcut&quot;</em> /&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;/aop:aspect&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;/aop:config&gt;</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">改进切面实现，使用事务策略规则匹配</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">之前的实现我们是将通过方法名匹配，而不是使用事务策略中的定义，我们使用事务管理策略中的规则匹配。</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">改进后的配置</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 定义AOP切面处理器 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;bean class=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;cn.itcast.usermanage.spring.DataSourceAspect&quot;</em> id=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;dataSourceAspect&quot;</em>&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 指定事务策略 --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;txAdvice&quot;</em> ref=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;txAdvice&quot;</em>/&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;!-- 指定slave方法的前缀（非必须） --&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;property name=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;slaveMethodStart&quot;</em> value=<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">&quot;query,find,get&quot;</em>/&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">&lt;/bean&gt;</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">改进后的实现</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> java.lang.reflect.Field;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> java.util.ArrayList;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> java.util.List;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> java.util.Map;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> org.apache.commons.lang3.StringUtils;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> org.aspectj.lang.JoinPoint;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> org.springframework.transaction.interceptor.NameMatchTransactionAttributeSource;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> org.springframework.transaction.interceptor.TransactionAttribute;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> org.springframework.transaction.interceptor.TransactionAttributeSource;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> org.springframework.transaction.interceptor.TransactionInterceptor;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> org.springframework.util.PatternMatchUtils;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> org.springframework.util.ReflectionUtils;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 定义数据源的AOP切面，该类控制了使用Master还是Slave。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 如果事务管理中配置了事务策略，则采用配置的事务策略中的标记了ReadOnly的方法是用Slave，其它使用Master。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 如果没有配置事务管理的策略，则采用方法名匹配的原则，以query、find、get开头方法用Slave，其它用Master。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@author</strong> zhijun</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">class</strong> DataSourceAspect {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">private</strong> List&lt;String&gt; slaveMethodPattern = <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">new</strong> ArrayList&lt;String&gt;();</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">private</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">static</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">final</strong> String[] <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">defaultSlaveMethodStart</em></strong> = <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">new</strong> String[]{ &quot;query&quot;, &quot;find&quot;, &quot;get&quot; };</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">private</strong> String[] slaveMethodStart;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 读取事务管理中的策略</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@param</strong> txAdvice</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@throws</strong> Exception</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">@SuppressWarnings(&quot;unchecked&quot;)</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">void</strong> setTxAdvice(TransactionInterceptor txAdvice) <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">throws</strong> Exception {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">if</strong> (txAdvice == <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">null</strong>) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 没有配置事务管理策略</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">return</strong>;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">//从txAdvice获取到策略配置信息</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">TransactionAttributeSource transactionAttributeSource = txAdvice.getTransactionAttributeSource();</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">if</strong> (!(transactionAttributeSource <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">instanceof</strong> NameMatchTransactionAttributeSource)) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">return</strong>;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">//使用反射技术获取到NameMatchTransactionAttributeSource对象中的nameMap属性值</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">NameMatchTransactionAttributeSource matchTransactionAttributeSource = (NameMatchTransactionAttributeSource) transactionAttributeSource;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">Field nameMapField = ReflectionUtils.<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">findField</em>(NameMatchTransactionAttributeSource.<strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">class</strong>, &quot;nameMap&quot;);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">nameMapField.setAccessible(<strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">true</strong>); //设置该字段可访问</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">//获取nameMap的值</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">Map&lt;String, TransactionAttribute&gt; map = (Map&lt;String, TransactionAttribute&gt;) nameMapField.get(matchTransactionAttributeSource);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">//遍历nameMap</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">for</strong> (Map.Entry&lt;String, TransactionAttribute&gt; entry : map.entrySet()) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">if</strong> (!entry.getValue().isReadOnly()) {//判断之后定义了ReadOnly的策略才加入到slaveMethodPattern</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">continue</strong>;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">slaveMethodPattern.add(entry.getKey());</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 在进入Service方法之前执行</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@param</strong> point 切面对象</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">void</strong> before(JoinPoint point) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 获取到当前执行的方法名</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">String methodName = point.getSignature().getName();</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">boolean</strong> isSlave = <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">false</strong>;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">if</strong> (slaveMethodPattern.isEmpty()) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 当前Spring容器中没有配置事务策略，采用方法名匹配方式</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">isSlave = isSlave(methodName);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">} <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">else</strong> {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 使用策略规则匹配</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">for</strong> (String mappedName : slaveMethodPattern) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">if</strong> (isMatch(methodName, mappedName)) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">isSlave = <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">true</strong>;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">break</strong>;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">if</strong> (isSlave) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 标记为读库</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">DynamicDataSourceHolder.<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">markSlave</em>();</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">} <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">else</strong> {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 标记为写库</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">DynamicDataSourceHolder.<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">markMaster</em>();</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 判断是否为读库</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@param</strong> methodName</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@return</strong></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">private</strong> Boolean isSlave(String methodName) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 方法名以query、find、get开头的方法名走从库</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">return</strong> StringUtils.<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">startsWithAny</em>(methodName, getSlaveMethodStart());</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 通配符匹配</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* Return if the given method name matches the mapped name.</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* &lt;p&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* The default implementation checks for &quot;xxx*&quot;, &quot;*xxx&quot; and &quot;*xxx*&quot; matches, as well as direct</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* equality. Can be overridden in subclasses.</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@param</strong> methodName the method name of the class</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@param</strong> mappedName the name in the descriptor</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@return</strong> if the names match</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@see</strong> org.springframework.util.PatternMatchUtils#simpleMatch(String, String)</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">protected</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">boolean</strong> isMatch(String methodName, String mappedName) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">return</strong> PatternMatchUtils.<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">simpleMatch</em>(mappedName, methodName);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 用户指定slave的方法名前缀</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@param</strong> slaveMethodStart</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">void</strong> setSlaveMethodStart(String[] slaveMethodStart) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">this</strong>.slaveMethodStart = slaveMethodStart;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> String[] getSlaveMethodStart() {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">if</strong>(<strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">this</strong>.slaveMethodStart == <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">null</strong>){</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 没有指定，使用默认</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">return</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">defaultSlaveMethodStart</em></strong>;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">return</strong> slaveMethodStart;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">一主多从的实现</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">很多实际使用场景下都是采用&quot;一主多从&quot;的架构的，所有我们现在对这种架构做支持，目前只需要修改DynamicDataSource即可。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><img src="小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））_files/46fc0001addba27e4fab.jpg" type="image/jpeg" data-filename="46fc0001addba27e4fab.jpg" alt="小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））" height="386" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;border-style:none;max-width:100%;display:block;margin:10px auto;" width="640"/></p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">实现</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> java.lang.reflect.Field;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> java.util.ArrayList;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> java.util.List;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> java.util.Map;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> java.util.concurrent.atomic.AtomicInteger;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> javax.sql.DataSource;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> org.slf4j.Logger;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> org.slf4j.LoggerFactory;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">import</strong> org.springframework.util.ReflectionUtils;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 定义动态数据源，实现通过集成Spring提供的AbstractRoutingDataSource，只需要实现determineCurrentLookupKey方法即可</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 由于DynamicDataSource是单例的，线程不安全的，所以采用ThreadLocal保证线程安全，由DynamicDataSourceHolder完成。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@author</strong> zhijun</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">class</strong> DynamicDataSource <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">extends</strong> AbstractRoutingDataSource {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">private</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">static</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">final</strong> Logger <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">LOGGER</em></strong> = LoggerFactory.<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">getLogger</em>(DynamicDataSource.<strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">class</strong>);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">private</strong> Integer slaveCount;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 轮询计数,初始为-1,AtomicInteger是线程安全的</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">private</strong> AtomicInteger counter = <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">new</strong> AtomicInteger(-1);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 记录读库的key</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">private</strong> List&lt;Object&gt; slaveDataSources = <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">new</strong> ArrayList&lt;Object&gt;(0);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">@Override</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">protected</strong> Object determineCurrentLookupKey() {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 使用DynamicDataSourceHolder保证线程安全，并且得到当前线程中的数据源key</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">if</strong> (DynamicDataSourceHolder.<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">isMaster</em>()) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">Object key = DynamicDataSourceHolder.<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">getDataSourceKey</em>();</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">if</strong> (<strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">LOGGER</em></strong>.isDebugEnabled()) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">LOGGER</em></strong>.debug(&quot;当前DataSource的key为: &quot; + key);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">return</strong> key;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">Object key = getSlaveKey();</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">if</strong> (<strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">LOGGER</em></strong>.isDebugEnabled()) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">LOGGER</em></strong>.debug(&quot;当前DataSource的key为: &quot; + key);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">return</strong> key;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">@SuppressWarnings(&quot;unchecked&quot;)</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">@Override</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">void</strong> afterPropertiesSet() {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">super</strong>.afterPropertiesSet();</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 由于父类的resolvedDataSources属性是私有的子类获取不到，需要使用反射获取</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">Field field = ReflectionUtils.<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">findField</em>(AbstractRoutingDataSource.<strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">class</strong>, &quot;resolvedDataSources&quot;);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">field.setAccessible(<strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">true</strong>); // 设置可访问</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">try</strong> {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">Map&lt;Object, DataSource&gt; resolvedDataSources = (Map&lt;Object, DataSource&gt;) field.get(<strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">this</strong>);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 读库的数据量等于数据源总数减去写库的数量</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">this</strong>.slaveCount = resolvedDataSources.size() - 1;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">for</strong> (Map.Entry&lt;Object, DataSource&gt; entry : resolvedDataSources.entrySet()) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">if</strong> (DynamicDataSourceHolder.<strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">MASTER</em></strong>.equals(entry.getKey())) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">continue</strong>;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">slaveDataSources.add(entry.getKey());</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">} <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">catch</strong> (Exception e) {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">LOGGER</em></strong>.error(&quot;afterPropertiesSet error! &quot;, e);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">/**</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* 轮询算法实现</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">* <strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">@return</strong></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">*/</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">public</strong> Object getSlaveKey() {</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">// 得到的下标为：0、1、2、3……</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">Integer index = counter.incrementAndGet() % slaveCount;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">if</strong> (counter.get() &gt; 9999) { // 以免超出Integer范围</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">counter.set(-1); // 还原</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">return</strong> slaveDataSources.get(index);</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">}</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">MySQL主从复制</h1><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">原理</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><img src="小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））_files/46f800051b752ef8ce6e.jpg" type="image/jpeg" data-filename="46f800051b752ef8ce6e.jpg" alt="小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））" height="339" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;border-style:none;max-width:100%;display:block;margin:10px auto;" width="506"/></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">mysql主(称master)从(称slave)复制的原理：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、 master将数据改变记录到二进制日志(binary log)中,也即是配置文件log-bin指定的文件(这些记录叫做二进制日志事件，binary log events)</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、 slave将master的binary log events拷贝到它的中继日志(relay log)</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3、 slave重做中继日志中的事件,将改变反映它自己的数据(数据重演)</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">主从配置需要注意的地方</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、 主DB server和从DB server数据库的版本一致</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、 主DB server和从DB server数据库数据一致[ 这里就会可以把主的备份在从上还原，也可以直接将主的数据目录拷贝到从的相应数据目录]</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3、 主DB server开启二进制日志,主DB server和从DB server的server_id都必须唯一</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">主库配置（windows，Linux下也类似）</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">在my.ini修改：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">#开启主从复制，主库的配置</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">log-bin = mysql3306-bin</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">#指定主库serverid</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">server-id=101</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">#指定同步的数据库，如果不指定则同步全部数据库</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">binlog-do-db=mybatis_1128</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">执行SQL语句查询状态：<em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">SHOW MASTER STATUS</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><img src="小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））_files/46fb0001d7491a446fca.jpg" type="image/jpeg" data-filename="46fb0001d7491a446fca.jpg" alt="小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））" height="107" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;border-style:none;max-width:100%;display:block;margin:10px auto;" width="660"/></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">需要记录下Position值，需要在从库中设置同步起始值。</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">在主库创建同步用户</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">#授权用户slave01使用123456密码登录mysql</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">grant replication slave on *.* to 'slave01'@'127.0.0.1' identified by '123456';</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">flush privileges;</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">从库配置</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">在my.ini修改：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">#指定serverid，只要不重复即可，从库也只有这一个配置，其他都在SQL语句中操作</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">server-id=102</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">以下执行SQL：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">CHANGE MASTER TO</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;"> master_host='127.0.0.1',</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;"> master_user='slave01',</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;"> master_password='123456',</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;"> master_port=3306,</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;"> master_log_file='mysql3306-bin.000006',</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;"> master_log_pos=1120;</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">#启动slave同步</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">START SLAVE;</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">#查看同步状态</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><em style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-weight:700;">SHOW SLAVE STATUS;</em></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><img src="小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））_files/46fc0001addd60662cdc.jpg" type="image/jpeg" data-filename="46fc0001addd60662cdc.jpg" alt="小马分享（如何使用Spring实现读写分离（MySQL实现主从复制））" height="556" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;border-style:none;max-width:100%;display:block;margin:10px auto;" width="535"/></p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">参考资料</h1></div></div>  <div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:block;zoom:1;margin-bottom:28px;"><span style="display:table;"></span><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;float:left;"><i style="font-variant-ligatures:normal;-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-size:21px;text-transform:none;display:inline-block;speak:none;font-weight:400;font-style:normal;font-variant-caps:normal;line-height:1;text-rendering:auto;-webkit-font-smoothing:antialiased;vertical-align:middle;font-family:tticons;color:rgb(202, 202, 202);"><span style="font-style:normal;font-size:12px;line-height:1;font-weight:400;text-transform:none;font-family:tticons;"></span></i> <ul style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;list-style:none;display:inline-block;vertical-align:middle;"><li style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:inline-block;margin-right:8px;font-size:14px;"><span style="font-size:14px;padding-right:10px;color:rgb(224, 224, 224);"></span><a href="https://www.toutiao.com/search/?keyword=MySQL" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;background:0px 0px;text-decoration:none;outline:0px;cursor:pointer;transition:color 0.2s ease;color:rgb(64, 101, 153);" target="_blank">MySQL</a></li><li style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:inline-block;margin-right:8px;font-size:14px;"><span style="font-size:14px;padding-right:10px;color:rgb(224, 224, 224);">/</span><a href="https://www.toutiao.com/search/?keyword=Linux" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;background:0px 0px;text-decoration:none;outline:0px;cursor:pointer;transition:color 0.2s ease;color:rgb(64, 101, 153);" target="_blank">Linux</a></li><li style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:inline-block;margin-right:8px;font-size:14px;"><span style="font-size:14px;padding-right:10px;color:rgb(224, 224, 224);">/</span><a href="https://www.toutiao.com/search/?keyword=%E7%A8%8B%E5%BA%8F%E5%91%98" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;background:0px 0px;text-decoration:none;outline:0px;cursor:pointer;transition:color 0.2s ease;color:rgb(64, 101, 153);" target="_blank">程序员</a></li><li style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:inline-block;margin-right:8px;font-size:14px;"><span style="font-size:14px;padding-right:10px;color:rgb(224, 224, 224);">/</span><a href="https://www.toutiao.com/search/?keyword=%E6%8A%80%E6%9C%AF" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;background:0px 0px;text-decoration:none;outline:0px;cursor:pointer;transition:color 0.2s ease;color:rgb(64, 101, 153);" target="_blank">技术</a></li></ul></div> <div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;float:right;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:inline-block;cursor:pointer;line-height:18px;"><i style="font-variant-ligatures:normal;-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-size:18px;text-transform:none;display:inline-block;speak:none;font-weight:400;font-style:normal;font-variant-caps:normal;line-height:1;text-rendering:auto;-webkit-font-smoothing:antialiased;width:18px;vertical-align:middle;font-family:tticons;color:rgb(202, 202, 202);"><span style="font-style:normal;font-size:12px;line-height:1;font-weight:400;text-transform:none;font-family:tticons;"></span></i><span style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;color:rgb(153, 153, 153);font-size:14px;padding-left:7px;vertical-align:middle;">收藏</span></div> <div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:inline-block;margin-left:10px;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:inline-block;cursor:pointer;line-height:18px;"><i style="font-variant-caps:normal;-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-size:14px;text-rendering:auto;display:inline-block;speak:none;font-weight:400;font-variant-ligatures:normal;font-style:normal;text-transform:none;line-height:1;-webkit-font-smoothing:antialiased;vertical-align:middle;width:14px;margin-right:7px;font-family:tticons;color:rgb(202, 202, 202);"><span style="font-style:normal;font-size:12px;line-height:1;font-weight:400;text-transform:none;font-family:tticons;"></span></i><span style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;color:rgb(153, 153, 153);font-size:14px;vertical-align:middle;">举报</span></div> </div></div><span style="display:block;visibility:hidden;font-size:0px;height:0px;clear:both;"></span></div></div></div></div></div></div></div></div><br/></div></span>
</div></body></html> 