<html>
<head>
  <title>惭愧呀！工作这么多年了，才知道“性能优化”是这么一回事！</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="5074"/>
<h1>惭愧呀！工作这么多年了，才知道“性能优化”是这么一回事！</h1>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;line-height:1.15;text-size-adjust:100%;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size:12px;line-height:1.5;color:rgb(101, 113, 128);background-color:rgb(255, 255, 255);-webkit-font-smoothing:antialiased;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;zoom:1;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-size:16px;line-height:28px;color:rgb(34, 34, 34);word-wrap:break-word;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-size:16px;line-height:28px;color:rgb(34, 34, 34);word-wrap:break-word;"><blockquote style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:1em 0px;padding:12px 10px;position:relative;font-size:16px;line-height:1.5;color:rgb(153, 153, 153);background:rgb(244, 245, 246);border:1px solid rgb(232, 232, 232);"><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">性能优化是什么？</strong> 答：性能优化，简而言之，就是在不影响系统运行正确性的前提下，使之运行地更快，完成特定功能所需的时间更短。</p></blockquote><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><img src="惭愧呀！工作这么多年了，才知道“性能优化”是这么一回事！_files/4e720001f2bd21298c42.jpg" type="image/jpeg" data-filename="4e720001f2bd21298c42.jpg" alt="惭愧呀！工作这么多年了，才知道“性能优化”是这么一回事！" height="200" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;border-style:none;max-width:100%;display:block;margin:10px auto;" width="356"/></p><blockquote style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:1em 0px;padding:12px 10px;position:relative;font-size:16px;line-height:1.5;color:rgb(153, 153, 153);background:rgb(244, 245, 246);border:1px solid rgb(232, 232, 232);"><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">前提是什么？</strong> 答：不影响系统运行正确性</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">目的是什么？</strong> 答：运行地更快时间更短，（ 改善应用的“吞吐量”和“延迟”。）</p></blockquote><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">性能优化的步骤：</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、性能监控：通常是指一种在生产、质量评估、开发环境中实施的带有预防或主动性的非侵入活动。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、性能分析：是一种以侵入方式收集运行性能数据的活动。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3、性能调优：是一种为改善应用响应性或吞度量而更改参数、源代码、或者属性配置活动。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><img src="惭愧呀！工作这么多年了，才知道“性能优化”是这么一回事！_files/4e720001fb68ff00a104.jpg" type="image/jpeg" data-filename="4e720001fb68ff00a104.jpg" alt="惭愧呀！工作这么多年了，才知道“性能优化”是这么一回事！" height="486" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;border-style:none;max-width:100%;display:block;margin:10px auto;" width="640"/></p><hr style="-webkit-tap-highlight-color:transparent;box-sizing:content-box;overflow:visible;padding:0px;height:4px;margin:40px auto;width:64px;background:rgb(237, 64, 64);outline:none;border:none;"/><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">性能监控</h1><blockquote style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:1em 0px;padding:12px 10px;position:relative;font-size:16px;line-height:1.5;color:rgb(153, 153, 153);background:rgb(244, 245, 246);border:1px solid rgb(232, 232, 232);"><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;">指一种在生产、质量评估、开发环境中实施的带有预防或主动性的非侵入活动。</p></blockquote><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">Windows性能监控命令</strong></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、CPU使用效率</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">使用typeperf监控 Privileged Time， User Time， Processor Time</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">C:Userszhangw&gt;typeperf &quot;Processor(_Total)% Privileged Time&quot; &quot;Processor(_Total)% User Time&quot; &quot;Processor(_Total)% Processor Time&quot;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、运行队列长度：通常不要长期超过虚拟处理器数量的3-4倍</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">C:Userszhangw&gt;typeperf &quot;SystemProcessor Queue Length&quot;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3、内存利用率--可用内存/页面交换、加锁、线程迁移</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">C:Userszhangw&gt;typeperf -si 5 &quot;MemoryAvailable Mbytes&quot; &quot;MemoryPages/sec&quot; --监控可用内存和每秒页面交换</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">4、锁竞争</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">需要借助外部工具如Intel VTune或AMD CodeAnalyst</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">Linux性能监控命令</strong></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、CPU使用效率</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">使用gnome-system-monitor监控</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">使用命令： vmstat 其中：us sy id分别对应 User Time，Privileged Time，Processor Time</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">使用命令： top</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、运行队列长度</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">使用命令： vmstat 其中：r代表队列长度</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3、内存利用率</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">使用命令： vmstat 其中：free代表可用的空闲内存，si和so分别代表内存页面换入和换出</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">4、锁竞争（多线程）---让步时钟周期占用超过5%的时钟周期，说明java应用正面临锁竞争</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">使用命令： pidstat -w -I -p 9391 5 每5秒监控进程id为9391的java应用的让步上下文切换</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">让步时钟周期= cswch/s * 80000/处理器内核数/处理器时钟频率</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">5、磁盘I/O使用率</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">使用命令：iostat</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">主要性能参数：</strong></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-client/-server 启动哪个JIT编译器</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-XX: +UseCompressOops 开启压缩指针</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-XX: +PrintCommandLineFlags -version 打印JVM默认设置的的优化值</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-Xmn、-XX:NewSize、-XX:MaxNewSize、-XX:NewRatio、 -XX:SurvivorRatio 调整新生代参数</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-verbose:gc -XX: +PrintGCDetails -XX: +PrintGCTimeStamps 打印GC信息</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-XX:PermSize -XX:MaxPermSize 调整永久代参数</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">JVM性能监控：</strong></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、JVM监控范围：垃圾收集、JIT编译、类加载。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、垃圾收集</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2.1 垃圾收集数据包括：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、当前使用的垃圾收集器</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、Java堆的大小</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3、新生代和老年代的大小</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">4、永久代的大小</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">5、MinorGC的持续时间</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">6、MinorGC的频率</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">7、MinorGC的空间回收量</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">8、FullGC的持续时间</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">9、FullGC的频率</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">10、每个并发垃圾收集周期内的空间回收量</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">11、垃圾收集前后新生代和老年代的占用量</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">12、垃圾收集前后永久代的占用量</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">13、是否老年代或永久代的占用触发了FullGC</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">14、应用是否显式调用了System.gc()</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2.2 监控垃圾收集的推荐选项</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-XX: +PrintGCDetails</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-XX: +PrintGCTimeStamps</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2.3 主要监控工具</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">Java VisualVM JConsole VisualGC (均适用于Windows,Linux)</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;"> JIT编译</strong></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3.1 JIT编译数据包括</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、CPU周期</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、内存</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3、编译时间</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3.2 监控JIT编译的推荐选项</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-XX: +PrintCompilation</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3.3 主要监控工具</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">Java VisualVM JConsole VisualGC (均适用于Windows,Linux)</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">类加载</strong></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">4.1 类加载数据包括</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、类加载数量</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、类卸载数量</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">4.2 监控类加载的推荐选项</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">4.3 主要监控工具</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">Java VisualVM VisualGC (均适用于Windows,Linux)</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><img src="惭愧呀！工作这么多年了，才知道“性能优化”是这么一回事！_files/4e76000198fa954c229c.jpg" type="image/jpeg" data-filename="4e76000198fa954c229c.jpg" alt="惭愧呀！工作这么多年了，才知道“性能优化”是这么一回事！" height="503" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;border-style:none;max-width:100%;display:block;margin:10px auto;" width="640"/></p><blockquote style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:1em 0px;padding:12px 10px;position:relative;font-size:16px;line-height:1.5;color:rgb(153, 153, 153);background:rgb(244, 245, 246);border:1px solid rgb(232, 232, 232);"><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;">如果大家有想学习了解的，可以加入我的Java高级架构进阶学习群：671017482</p></blockquote><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">JVM性能分析：</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">分析指标：用户态CPU时间、系统态CPU时间、锁竞争</p><h1 style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-size:24px;margin:36px 0px 22px;font-weight:700;line-height:32px;color:rgb(34, 34, 34);">JVM性能调优</h1><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">（1）性能需求：可用性、可管理性、启动时间、内存消耗、吞吐量、响应时间</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、可用性：应用程序处于可操作、可使用状态的度量。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、可管理性：是对由运行、监控应用程序而产生的操作性开销的度量同时也包括配置应用程序的难易程度。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3、吞吐量：单位时间内处理工作量的度量。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">4、延迟及响应性：应用程序收到指令开始工作直到完成工作所消耗的时间。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">5、内存消耗：内存占有的度量。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">6、启动时间：应用程序初始化所消耗的时间。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">（2）由于各个指标都是互斥的，因此性能调优过程的第一步是划分应用程序的系统需求优先级。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">（3）优化过程：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">选择JVM部署模式</strong>：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">（1） 单JVM部署模式：降低管理成本、减少内存开销、存在单点故障无法保证程序可用性。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">（2） 多JVM部署模式： 更高可用性、降低延迟、提高吞吐量、增加了管理代价。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">选择JVM启动模式</strong>：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">（1） Client模式：启动速度快、占用内存少、JIT编译速度快</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">（2）Server模式：提供了更复杂的生成码优化功能，</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3、32/64位JVM：</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">（1）HotSpot默认使用32位，使用32位还是64位JVM是由应用程序的内存占用决定的，同时考虑第三方库是否支持64位。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">（2）在64位JVM中，使用JNI的所有本地组件都必须用64位模式编译。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">选择初始垃圾收集器</strong>：JVM提供多个垃圾收集器如:Serial收集器、Throughput收集器、Mostly-Concurrent收集器、G1收集器</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">（1）使用 -XX:+UseParallelOldGC 或 -XX:+UseParallelGC命令启动Throughput收集器。两个命令的区别：-XX:+UseParallelOldGC同时启用多线程新生代垃圾收集器和多线程老年代垃圾收集器；-XX:+UseParallelGC仅仅启用多线程新生代垃圾收集器，老年代仍采用单线程。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">（2）使用 -XX:+</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><img src="惭愧呀！工作这么多年了，才知道“性能优化”是这么一回事！_files/4e730001f6a82ae1c875.gif" type="image/gif" data-filename="4e730001f6a82ae1c875.gif" alt="惭愧呀！工作这么多年了，才知道“性能优化”是这么一回事！" height="306" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;border-style:none;max-width:100%;display:block;margin:10px auto;" width="600"/></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;text-align:center;font-size:12px;color:rgb(119, 119, 119);line-height:16px;margin-top:0px;">继续往下看，有彩蛋</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">垃圾收集调优</strong></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、性能属性： 吞吐量、延迟、内存占用</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">吞吐量: （不考虑垃圾收集引起的停顿时间或内存消耗）垃圾收集器能支撑应用程序达到的最高性能指标</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">延迟: 垃圾收集所引起的停顿。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">内存占用：垃圾收集器流畅运行所需要的内存数量。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、调优原则：MinorGC回收原则、GC内存最大化原则、GC调优的3选2原则</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3、GC日志相关的命令行选项</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-XX:+PrintGCTimeStamps -XX:+PrintGCDetails -Xloggc:&lt;filename&gt;</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">4、 获得应用程序由于执行VM安全点操作而阻塞的时间命令选项</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-XX:+PrintGCApplicationStoppedTime</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-XX:+PrintGCApplicationConcurrentTime</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">安全点操作：使用JVM进入到一种状态，即所有Java应用线程都被阻塞且不能修改java堆，执行本地代码的线程都被禁止返回VM执行Java代码</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">5、确定内存占用</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">活跃数据的大小: 应用程序稳定运行时长期存活对象所占用的java堆内存量，即FullGC之后java堆所占用的空间大小</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-Xms :堆的初始值和最小值</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-Xmx :堆区的最大值</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">如果关注吞吐量和延迟的应用程序应该将-Xms和-Xmx设定为相同，因为堆区动态扩展会进行FullGC，设定为同一个值尽量减少堆区动态扩展。 如果-Xms和-Xmx设定为相同，可以通过-Xmn设置不能动态扩展的新生代空间。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">6、新生代 理想设置：应该设置新生代大小为老年代活跃数据的1-1.5倍</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-XX:Newsize=&lt;n&gt;[g|m|k] :设定新生代空间初始值大小</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-XX:MaxNewsize=&lt;n&gt;[g|m|k] :设定新生代空间最大值</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">7、老年代 　理想设置：应该设置老年代大小为老年代活跃数据的大小的3－4倍</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">老年代最小值 = -Xmx的值 - -XX:MaxNewsize</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">老年代最大值 = -Xmx的值 - -XX:Newsize</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">8、永久代 理想设置：应该设置永久代大小为永久代活跃数据的大小的1.5倍</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-XX:PermSize=&lt;n&gt;[g|m|k] :永久代初始值和最小值</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-XX:MaxPermSize=&lt;n&gt;[g|m|k] :永久代最大值</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">9、何时触发垃圾收集</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">新生代、老年代、永久代这三个空间中的任何一个不能满足内存分配请求时，就会发生垃圾收集。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">10、活跃数据大小</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">应用程序运行稳定态时，活跃数据大小=老年代占用大小 + 永久代占用大小，可以使用JVM监控工具VisualVM或JConsole等触发一次FullGC进行计算，（明智的做法多进行几次FullGC求解平均值）</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">11、整个JVM堆区 理想设置： 整个JVM堆区的初始值和最大值大小应该设置为为活跃数据大小的3-4倍</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">12、其他考量：Java堆区大小并不等于java应用程序占用的物理机的总内存，java应用程序的内存使用情况使用操作系统工具：prstat/top/任务管理器。 线程栈也可能需要较多的内存，第三方库分配内存、I/O缓存都可以导致使用较多的内存</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><strong style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-weight:700;">应用程序延迟/响应调优</strong></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、响应调优需求</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">1、应用程序可接受的平均停滞时间；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、可接受的MinorGC频率；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3、用户可接受的应用程序最大停顿时间；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">4、用户可接受的最大停顿发生的频率；</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">2、新生代</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">MinorGC的持续时间和频率可以确定新生代空间的大小，如果MinorGC的频率大于应用程序的延迟频率（发生的太频繁）增大新生代空间；如果MinorGC持续时间太长，可以适当减小新生代空间</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">3、老年代</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">FullGC持续的时间和频率可以确定老年代空间的大小</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">4、Survivor空间大小调优</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">Survivor空间大小 = -Xmn&lt;value&gt; / （-XX:SurvivorRatio=&lt;ratio&gt; + 2）</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">-XX:MaxTenuringThreshold=&lt;n&gt; 设置新生代到老年代的晋升阈值</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">如果Survivor空间大小小于总的存活对象大小或者观察到新晋升阈值持续小于最大晋升阈值 都需要增大器容量，增大Survivor空间需要保持Eden空间不变，因此需要增大整个新生代区间大小。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">5、CMS收集周期调优</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;">成功的CMS收集器调优要能以对象从新生代提升到老年代的同等速度对老年代中的对象进行垃圾收集。</p><blockquote style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:1em 0px;padding:12px 10px;position:relative;font-size:16px;line-height:1.5;color:rgb(153, 153, 153);background:rgb(244, 245, 246);border:1px solid rgb(232, 232, 232);"><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;">好咯，今天就弄到这里，下篇文章我们就继续深挖“性能优化”，当然你如果有特别想了解的“其他方面的问题”，留言给我，我也会提前更新的，有想法的也可以加我的群：671017482，谢谢大家！</p></blockquote><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;margin:16px 0px;"><img src="惭愧呀！工作这么多年了，才知道“性能优化”是这么一回事！_files/4e6f00043a0bd3ac3413.gif" type="image/gif" data-filename="4e6f00043a0bd3ac3413.gif" alt="惭愧呀！工作这么多年了，才知道“性能优化”是这么一回事！" height="300" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;border-style:none;max-width:100%;display:block;margin:10px auto;" width="400"/></p></div></div></div></div></div></div></div></div></div><br/></div></span>
</div></body></html> 