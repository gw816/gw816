<html>
<head>
  <title>WinPE：装载和自定义 - Windows 10 hardware dev.html</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="901"/>
<h1>WinPE：装载和自定义 - Windows 10 hardware dev.html</h1>

<div>
<span><p>将驱动程序添加到 Windows 预安装环境 (WinPE)，例如图形驱动程序或网络驱动程序。</p><p>常用自定义：</p><ul><li><a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938381.aspx">添加设备驱动程序（.inf 文件）</a>。你可以自定义设备驱动程序，例如用于支持网卡或存储设备的驱动程序。</li><li><a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938382.aspx">添加数据包（.cab 文件，又称为 WinPE 可选组件）</a>添加语言、修补程序，或对 PowerShell 和 HTML 应用程序语言 (HTA) 等功能的支持。</li><li><a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938382.aspx">添加语言</a>。若要以多语言运行 WinPE，请为这些语言添加语言包（可选组件）。</li><li>添加文件和文件夹。它们可以直接添加到 WinPE 映像中。</li><li><a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn898515.aspx">添加较新版本的 DISM</a>。如果新版本的 Windows 需要最新版 DISM 中的功能，你可以将 DISM 直接添加到 WinPE 中。</li><li><a href="#AddStartupScript">添加启动脚本</a>。包括设置网络连接或添加自定义应用程序（例如诊断软件）的示例。</li><li><a href="#AddApp">添加应用</a>。请注意，WinPE 仅支持旧版应用。</li><li><a href="#ScratchSpace">添加临时存储（暂存空间）</a>。如果你的应用程序需要临时文件存储，可以在 RAM 中保留额外的内存空间。</li><li><a href="#AddWallpaper">替换背景图像</a></li><li><a href="#AddAnswerFileSettings">添加应答文件设置</a></li></ul><p><img src="WinPE：装载和自定义 - Windows 10 hardware dev.html_files/Image.gif" type="image/gif" data-filename="Image.gif" alt="Dn938390.wedge(zh-cn,VS.85).gif" style="height: auto;" title="Dn938390.wedge(zh-cn,VS.85).gif"/><strong>获取带有 Windows PE 工具的 Windows 评估和部署工具包</strong></p><ul><li><p>安装 <a href="http://go.microsoft.com/fwlink/p/?LinkId=526803">Windows 评估和部署工具包 (Windows ADK) 技术参考</a>，包括 <strong>Windows PE</strong> 功能。</p></li></ul><p><img src="WinPE：装载和自定义 - Windows 10 hardware dev.html_files/Image [1].gif" type="image/gif" data-filename="Image.gif" alt="Dn938390.wedge(zh-cn,VS.85).gif" style="height: auto;" title="Dn938390.wedge(zh-cn,VS.85).gif"/><strong>创建一组 32 位或 64 位 Windows PE 文件</strong></p><ol><li><p>单击“开始”，并键入“部署”。右键单击“部署和映像工具环境”，然后选择“以管理员身份运行”。</p></li><li><p>在“部署工具和映像环境”中，复制用于要启动的电脑的 WinPE 文件。</p><ul><li><p>64 位版本可以启动 64 位 UEFI 电脑和 64 位 BIOS 电脑。</p><div><a name="CodeSnippetCopyLink" style="display: none;" title="复制到剪贴板。">复制</a></div><div dir="ltr"><div style="color:Black;"><pre>
copype amd64 C:\WinPE_amd64
</pre></div></div></li><li><p>32 位版本的 WinPE 可以启动 32 位 UEFI 电脑、32 位 BIOS 电脑和 64 位 BIOS 电脑。</p><div><a name="CodeSnippetCopyLink" style="display: none;" title="复制到剪贴板。">复制</a></div><div dir="ltr"><div style="color:Black;"><pre>
copype x86 C:\WinPE_x86
</pre></div></div></li></ul></li></ol><p><img src="WinPE：装载和自定义 - Windows 10 hardware dev.html_files/Image [2].gif" type="image/gif" data-filename="Image.gif" alt="Dn938390.wedge(zh-cn,VS.85).gif" style="height: auto;" title="Dn938390.wedge(zh-cn,VS.85).gif"/><strong>装载 Windows PE 启动映像</strong></p><ul><li><p>装载 WinPE 映像。</p><div><a name="CodeSnippetCopyLink" style="display: none;" title="复制到剪贴板。">复制</a></div><div dir="ltr"><div style="color:Black;"><pre>
Dism /Mount-Image /ImageFile:&quot;C:\WinPE_amd64\media\sources\boot.wim&quot; /index:1 /MountDir:&quot;C:\WinPE_amd64\mount&quot;
</pre></div></div></li></ul><h2>添加自定义</h2><p><img src="WinPE：装载和自定义 - Windows 10 hardware dev.html_files/Image [3].gif" type="image/gif" data-filename="Image.gif" alt="Dn938390.wedge(zh-cn,VS.85).gif" style="height: auto;" title="Dn938390.wedge(zh-cn,VS.85).gif"/><strong>添加设备驱动程序（.inf 文件）</strong></p><ul><li><p>将设备驱动程序添加到 WinPE 映像。</p><div><a name="CodeSnippetCopyLink" style="display: none;" title="复制到剪贴板。">复制</a></div><div dir="ltr"><div style="color:Black;"><pre>
Dism /Add-Driver /Image:&quot;C:\WinPE_amd64\mount&quot; /Driver:&quot;C:\SampleDriver\driver.inf&quot;
</pre></div></div><p>虽然可以通过使用一个命令，将多个驱动程序添加到一个映像，但是逐个添加各个驱动程序包，通常更容易解决疑难问题。</p><p>若要了解有关驱动程序的详细信息，请参阅<a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938381.aspx">添加设备驱动程序（.inf 文件）</a>。</p></li></ul><p><img src="WinPE：装载和自定义 - Windows 10 hardware dev.html_files/Image [4].gif" type="image/gif" data-filename="Image.gif" alt="Dn938390.wedge(zh-cn,VS.85).gif" style="height: auto;" title="Dn938390.wedge(zh-cn,VS.85).gif"/><strong>添加程序包/语言/可选组件/.cab 文件</strong></p><ul><li><p>将可选组件添加到 WinPE。要添加可选组件，需要同时添加可选组件及其关联的语言包。</p><div><a name="CodeSnippetCopyLink" style="display: none;" title="复制到剪贴板。">复制</a></div><div dir="ltr"><div style="color:Black;"><pre>
Dism /Add-Package /Image:&quot;C:\WinPE_amd64\mount&quot; /PackagePath:&quot;C:\Program Files\Windows Kits\8.1\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\WinPE-HTA.cab&quot;  

Dism /Add-Package /Image:&quot;C:\WinPE_amd64\mount&quot; /PackagePath:&quot;C:\Program Files\Windows Kits\8.1\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\en-us\WinPE-HTA_en-us.cab&quot;
</pre></div></div><p>若要了解有关添加程序包的详细信息，请参阅 <a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938382.aspx">WinPE：添加程序包（可选组件参考）</a>。</p></li></ul><p><img src="WinPE：装载和自定义 - Windows 10 hardware dev.html_files/Image [5].gif" type="image/gif" data-filename="Image.gif" alt="Dn938390.wedge(zh-cn,VS.85).gif" style="height: auto;" title="Dn938390.wedge(zh-cn,VS.85).gif"/><strong>添加文件和文件夹</strong></p><ul><li><p>将文件和文件夹复制到 C:\WinPE_amd64\mount 文件夹中。这些文件将显示在 WinPE 的 X:\ 文件夹中。</p><p>请不要添加太多文件，因为这些文件会减慢 WinPE 的速度，并且可能会填满默认 RAMDisk 环境中的可用内存。</p></li></ul><p><img src="WinPE：装载和自定义 - Windows 10 hardware dev.html_files/Image [6].gif" type="image/gif" data-filename="Image.gif" alt="Dn938390.wedge(zh-cn,VS.85).gif" style="height: auto;" title="Dn938390.wedge(zh-cn,VS.85).gif"/><strong>添加启动脚本</strong></p><ul><li><p>修改 Startnet.cmd 脚本以包括自定义命令。该文件位于 <code>C:\WinPE_amd64\mount\Windows\System32\Startnet.cmd</code>。</p><p>你还可以从该文件中调用其他批处理文件或命令行脚本。</p><p>要获得即插即用或网络支持，请确保在自定义的 Startnet.cmd 脚本中包括对 <strong>wpeinit</strong> 的调用。有关详细信息，请参阅 <a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938394.aspx">Wpeinit 和 Startnet.cmd：使用 WinPE 启动脚本</a>。</p></li></ul><p><img src="WinPE：装载和自定义 - Windows 10 hardware dev.html_files/Image [7].gif" type="image/gif" data-filename="Image.gif" alt="Dn938390.wedge(zh-cn,VS.85).gif" style="height: auto;" title="Dn938390.wedge(zh-cn,VS.85).gif"/><strong>添加应用</strong></p><ol><li><p>在已装载的 WinPE 映像内部创建应用目录。</p><div><a name="CodeSnippetCopyLink" style="display: none;" title="复制到剪贴板。">复制</a></div><div dir="ltr"><div style="color:Black;"><pre>
md &quot;C:\WinPE_amd64\mount\windows\&lt;MyApp&gt;&quot;
</pre></div></div></li><li><p>将必要的应用文件复制到本地 WinPE 目录中。</p><div><a name="CodeSnippetCopyLink" style="display: none;" title="复制到剪贴板。">复制</a></div><div dir="ltr"><div style="color:Black;"><pre>
Xcopy C:\&lt;MyApp&gt; &quot;C:\WinPE_amd64\mount\windows\&lt;MyApp&gt;&quot;
</pre></div></div></li><li><p>稍后通过启动 WinPE 并从 X: 目录运行应用程序来测试应用。</p><div><a name="CodeSnippetCopyLink" style="display: none;" title="复制到剪贴板。">复制</a></div><div dir="ltr"><div style="color:Black;"><pre>
X:\Windows\System32&gt; X:\Windows\&lt;MyApp&gt;
</pre></div></div><p>如果你的应用需要临时存储，或者如果 WinPE 在运行应用时无响应，你可能需要增加分配到 WinPE 的临时存储（暂存空间）的量。</p></li><li><p>若要自动启动 shell 或在 WinPE 启动时运行的应用程序，请将路径位置添加到 Winpeshl.ini 文件。有关详细信息，请参阅 <a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938379.aspx">Winpeshl.ini 参考：在 WinPE 启动时启动应用</a>。</p></li></ol><p><img src="WinPE：装载和自定义 - Windows 10 hardware dev.html_files/Image [8].gif" type="image/gif" data-filename="Image.gif" alt="Dn938390.wedge(zh-cn,VS.85).gif" style="height: auto;" title="Dn938390.wedge(zh-cn,VS.85).gif"/><strong>添加临时存储（暂存空间）</strong></p><ul><li><p>WinPE 在 X: 驱动器上保留内存以及称为暂存空间的额外临时文件存储，以解压可能用于你的应用程序的 WinPE 文件。对于 RAM 大于 1GB 的电脑，默认大小为 512MB；其他情况下，默认大小为 32MB。有效值为 32、64、128、256 或 512。</p><div><a name="CodeSnippetCopyLink" style="display: none;" title="复制到剪贴板。">复制</a></div><div dir="ltr"><div style="color:Black;"><pre>
Dism /Set-ScratchSpace:256 /Image:&quot;C:\WinPE_amd64\mount&quot;
</pre></div></div></li></ul><p><img src="WinPE：装载和自定义 - Windows 10 hardware dev.html_files/Image [9].gif" type="image/gif" data-filename="Image.gif" alt="Dn938390.wedge(zh-cn,VS.85).gif" style="height: auto;" title="Dn938390.wedge(zh-cn,VS.85).gif"/><strong>替换背景图像</strong></p><ol><li><p>如果你具有多个版本的 WinPE，可以设置背景图像，以便立即分辨正在运行哪个版本的 WinPE。</p><p>更改 WinPE 背景图像文件 (<code>\windows\system32\winpe.jpg</code>) 的安全权限。这使你可以修改或删除文件。</p><ol><li><p>在 Windows 资源管理器中，导航到 <code>C:\WinPE_amd64\mount\windows\system32</code>。</p></li><li><p>右键单击 <code>C:\WinPE_amd64\mount\windows\system32\winpe.jpg</code> 文件，然后依次选择“属性”&gt;“安全”选项卡 &gt;“高级”。</p></li><li><p>在“所有者”旁边，选择“更改”。将所有者更改为“管理员”。</p></li><li><p>应用更改，然后退出“属性”窗口以保存更改。</p></li><li><p>右键单击 <code>C:\WinPE_amd64\mount\windows\system32\winpe.jpg</code> 文件，然后依次选择“属性”&gt;“安全”选项卡 &gt;“高级”。</p></li><li><p>修改“管理员”的权限以允许完全访问。</p></li><li><p>应用更改，然后退出“属性”窗口以保存更改。</p></li></ol></li><li><p>使用自己的图像文件替换 <code>winpe.jpg</code> 文件。</p></li></ol><p><img src="WinPE：装载和自定义 - Windows 10 hardware dev.html_files/Image [10].gif" type="image/gif" data-filename="Image.gif" alt="Dn938390.wedge(zh-cn,VS.85).gif" style="height: auto;" title="Dn938390.wedge(zh-cn,VS.85).gif"/><strong>添加应答文件设置</strong></p><ul><li><p>可以使用应答文件管理某些 WinPE 设置，例如防火墙、网络和显示设置。创建应答文件并命名为 unattend.xml，然后将其添加到 WinPE 介质的根目录以处理这些设置。有关详细信息，请参阅 <a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938394.aspx">Wpeinit 和 Startnet.cmd：使用 WinPE 启动脚本</a>。</p></li></ul><p><img src="WinPE：装载和自定义 - Windows 10 hardware dev.html_files/Image [11].gif" type="image/gif" data-filename="Image.gif" alt="Dn938390.wedge(zh-cn,VS.85).gif" style="height: auto;" title="Dn938390.wedge(zh-cn,VS.85).gif"/><strong>卸载 Windows PE 映像并创建介质</strong></p><ol><li><p>卸载 WinPE 映像。</p><div><a name="CodeSnippetCopyLink" style="display: none;" title="复制到剪贴板。">复制</a></div><div dir="ltr"><div style="color:Black;"><pre>
Dism /Unmount-Image /MountDir:&quot;C:\WinPE_amd64\mount&quot; /commit
</pre></div></div></li><li><p>创建可启动介质，如 U 盘。</p><div><a name="CodeSnippetCopyLink" style="display: none;" title="复制到剪贴板。">复制</a></div><div dir="ltr"><div style="color:Black;"><pre>
MakeWinPEMedia /UFD C:\WinPE_amd64 F:
</pre></div></div></li><li><p>启动该介质。WinPE 自动启动。WinPE 窗口出现后，wpeinit 命令将自动运行。这可能需要几分钟。验证你的自定义。</p></li></ol><h2>疑难解答</h2><ul><li>WinPE 无法启动？请参阅以下主题结尾处的疑难解答提示：<a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938386.aspx">WinPE：创建 USB 可引导驱动器</a></li><li>有关连接到网络的提示，请参阅 <a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938391.aspx">WinPE 网络驱动程序：初始化和添加驱动程序</a>。</li><li>如果 WinPE 映像不可用，你可能需要先清除映像，才能重新装载映像。相关信息，请参阅<a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938310.aspx">修复 Windows 映像</a>。</li></ul><h3>删除工作目录的步骤：</h3><p>在某些情况下，你可能不能恢复已装载的映像。因为 DISM 可防止意外删除工作目录，所以你可能需要尝试以下步骤来获取访问权限，以删除已装载的目录。请尝试以下每个步骤：</p><ol><li><p>请尝试重新安装映像：</p><div><a name="CodeSnippetCopyLink" style="display: none;" title="复制到剪贴板。">复制</a></div><div dir="ltr"><div style="color:Black;"><pre>
dism /Remount-Image /MountDir:C:\mount
</pre></div></div></li><li><p>请尝试卸载映像，并放弃更改：</p><div><a name="CodeSnippetCopyLink" style="display: none;" title="复制到剪贴板。">复制</a></div><div dir="ltr"><div style="color:Black;"><pre>
dism /Unmount-Image /MountDir:C:\mount /discard
</pre></div></div></li><li><p>请尝试清除与已装载的映像相关联的资源：</p><div><a name="CodeSnippetCopyLink" style="display: none;" title="复制到剪贴板。">复制</a></div><div dir="ltr"><div style="color:Black;"><pre>
dism /Cleanup-Mountpoints
</pre></div></div></li></ol><h2>相关主题</h2><dl><dt><a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938389.aspx">适用于 Windows 10 的 WinPE</a></dt><dt><a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938386.aspx">WinPE：创建 USB 可引导驱动器</a></dt><dt><a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938385.aspx">WinPE：创建启动 CD、DVD、ISO 或 VHD</a></dt><dt><a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938388.aspx">WinPE：在硬盘驱动器上安装（平启动或非 RAM）</a></dt><dt><a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938383.aspx">WinPE：在 UEFI 或旧版 BIOS 模式下启动</a></dt><dt><a href="https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn938382.aspx">WinPE：添加程序包（可选组件参考）</a></dt></dl><p> </p><p> </p></span>
</div></body></html> 